---
// Enable SSR for dynamic slugs
export const prerender = false;

import MainLayout from '../../layouts/MainLayout.astro';
import { AdminPanel } from '../../components/admin/AdminPanel';
import { getWeddingBySlugAsync } from '../../lib/weddingData';

const { slug } = Astro.params;
const wedding = await getWeddingBySlugAsync(slug as string);

if (!wedding) {
  return Astro.redirect('/404');
}
---

<MainLayout
  title={`Administration - ${wedding.name}`}
  description={`Panneau d'administration pour ${wedding.name}`}
  showHeader={false}
>
  <AdminPanel
    client:load
    weddingId={wedding.id}
    weddingSlug={slug}
    initialView="dashboard"
  />
</MainLayout>

<script>
  // Check authentication on client side
  if (typeof window !== 'undefined') {
    const clientToken = localStorage.getItem('reflets_client_token');
    const clientSession = localStorage.getItem('reflets_client_session');
    const godImpersonation = localStorage.getItem('reflets_god_impersonation');
    const guestSession = localStorage.getItem('reflets_guest_session');

    // Allow access if:
    // 1. Client is logged in
    // 2. God admin is impersonating
    // 3. Guest has admin code access
    let hasAccess = false;

    if (clientToken && clientSession) {
      hasAccess = true;
    } else if (godImpersonation) {
      hasAccess = true;
    } else if (guestSession) {
      try {
        const session = JSON.parse(guestSession);
        if (session.access_type === 'admin') {
          hasAccess = true;
        }
      } catch (e) {}
    }

    // Also check old demo auth
    const isAdmin = localStorage.getItem('reflets_is_admin');
    if (isAdmin === 'true') {
      hasAccess = true;
    }

    if (!hasAccess) {
      // Redirect to login
      window.location.href = '/connexion';
    }
  }
</script>
