---
// Enable SSR for dynamic slugs
export const prerender = false;

import MainLayout from '../../layouts/MainLayout.astro';
import { AdminPanel } from '../../components/admin/AdminPanel';
import { getWeddingBySlugAsync } from '../../lib/weddingData';

const { slug } = Astro.params;
const wedding = await getWeddingBySlugAsync(slug as string);

if (!wedding) {
  return Astro.redirect('/404');
}

const { config } = wedding;
---

<MainLayout
  title={`Administration - ${wedding.name}`}
  description={`Panneau d'administration pour ${wedding.name}`}
>
  <!-- Hero Section -->
  <section class="relative py-12 sm:py-16 overflow-hidden bg-gradient-to-b from-cream to-cream-dark">
    <!-- Subtle pattern overlay -->
    <div class="absolute inset-0 opacity-[0.02]" style="background-image: url('data:image/svg+xml,%3Csvg width=\"60\" height=\"60\" viewBox=\"0 0 60 60\" xmlns=\"http://www.w3.org/2000/svg\"%3E%3Cg fill=\"none\" fill-rule=\"evenodd\"%3E%3Cg fill=\"%23ae1725\" fill-opacity=\"1\"%3E%3Cpath d=\"M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z\"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');"></div>

    <div class="container mx-auto px-4 sm:px-6 lg:px-8 relative z-10">
      <div class="text-center max-w-3xl mx-auto">
        <!-- Decorative top element -->
        <div class="mb-4">
          <span class="text-[#ae1725]/70 tracking-[0.3em] uppercase text-xs font-sans font-medium">
            Espace priv√©
          </span>
        </div>

        <!-- Title -->
        <h1 class="font-serif text-3xl sm:text-4xl lg:text-5xl text-charcoal mb-4 font-light">
          Administration
        </h1>

        <!-- Wedding Name -->
        <p class="text-charcoal-light/80 font-light max-w-xl mx-auto leading-relaxed text-lg">
          {config.welcomeTitle || wedding.name}
        </p>

        <!-- Decorative Divider -->
        <div class="flex items-center justify-center gap-4 mt-6">
          <div class="w-12 h-px bg-[#ae1725]/30"></div>
          <svg class="w-6 h-6 text-[#ae1725]/50" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
          </svg>
          <div class="w-12 h-px bg-[#ae1725]/30"></div>
        </div>
      </div>
    </div>

    <!-- Bottom decorative border -->
    <div class="absolute bottom-0 left-0 right-0">
      <svg viewBox="0 0 1200 20" preserveAspectRatio="none" class="w-full h-4 text-pearl-white fill-current">
        <path d="M0,20 L0,10 Q300,0 600,10 T1200,10 L1200,20 Z" />
      </svg>
    </div>
  </section>

  <!-- Admin Content -->
  <div class="bg-pearl-white">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-12 sm:py-16">
      <!-- Quick Navigation -->
      <div class="mb-8 flex flex-wrap gap-3 justify-center">
        <a
          href={`/${slug}`}
          class="inline-flex items-center gap-2 px-4 py-2 bg-white border border-silver-mist rounded-lg text-sm text-charcoal hover:border-[#ae1725] hover:text-[#ae1725] transition-colors"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
          </svg>
          Accueil
        </a>
        <a
          href={`/${slug}/photos`}
          class="inline-flex items-center gap-2 px-4 py-2 bg-white border border-silver-mist rounded-lg text-sm text-charcoal hover:border-[#ae1725] hover:text-[#ae1725] transition-colors"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
          Galerie
        </a>
        <a
          href={`/${slug}/livre-or`}
          class="inline-flex items-center gap-2 px-4 py-2 bg-white border border-silver-mist rounded-lg text-sm text-charcoal hover:border-[#ae1725] hover:text-[#ae1725] transition-colors"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
          </svg>
          Livre d'or
        </a>
      </div>

      <!-- Admin Panel Component -->
      <AdminPanel client:load weddingId={wedding.id} weddingSlug={slug} />
    </div>
  </div>
</MainLayout>

<script>
  // Check authentication on client side
  if (typeof window !== 'undefined') {
    const clientToken = localStorage.getItem('reflets_client_token');
    const clientSession = localStorage.getItem('reflets_client_session');
    const godImpersonation = localStorage.getItem('reflets_god_impersonation');
    const guestSession = localStorage.getItem('reflets_guest_session');

    // Allow access if:
    // 1. Client is logged in
    // 2. God admin is impersonating
    // 3. Guest has admin code access
    let hasAccess = false;

    if (clientToken && clientSession) {
      hasAccess = true;
    } else if (godImpersonation) {
      hasAccess = true;
    } else if (guestSession) {
      try {
        const session = JSON.parse(guestSession);
        if (session.access_type === 'admin') {
          hasAccess = true;
        }
      } catch (e) {}
    }

    // Also check old demo auth
    const isAdmin = localStorage.getItem('reflets_is_admin');
    if (isAdmin === 'true') {
      hasAccess = true;
    }

    if (!hasAccess) {
      // Redirect to login
      window.location.href = '/connexion';
    }
  }
</script>
