# ðŸ”´ CRITICAL: SSRF Vulnerability in fetchFile

**Status:** completed
**Priority:** P1 (CRITICAL - Blocks merge)
**Category:** Security
**Created:** 2026-02-04
**Completed:** 2026-02-04
**Source:** Code review PR #37 - security-sentinel agent

## Problem

The `fetchFile()` function in `src/lib/r2/client.ts` accepts any key without validation, allowing Server-Side Request Forgery (SSRF) attacks. An attacker could potentially read internal resources or scan internal networks.

**Attack Scenario:**
1. Attacker crafts a key like `../../etc/passwd` or `../internal-api/secrets`
2. `fetchFile()` passes this directly to S3 GetObjectCommand
3. Depending on S3 configuration, may access unintended resources

**Severity:** CRITICAL - Potential data breach

## Current Code

`src/lib/r2/client.ts:240-271`
```typescript
export async function fetchFile(key: string): Promise<Buffer> {
  const config = getR2Config();
  if (!config) {
    throw new Error('R2 is not configured');
  }

  const client = getS3Client();

  try {
    const command = new GetObjectCommand({
      Bucket: config.bucketName,
      Key: key,  // âŒ No validation!
    });
    // ... rest of function
  }
}
```

## Solution

Add strict key validation:

```typescript
/**
 * Validate that a storage key follows expected pattern
 * @throws Error if key is invalid
 */
function validateStorageKey(key: string): void {
  // Must start with weddings/ prefix
  if (!key.startsWith('weddings/')) {
    throw new Error('Invalid storage key: must start with weddings/');
  }

  // No path traversal attempts
  if (key.includes('..') || key.includes('//')) {
    throw new Error('Invalid storage key: path traversal detected');
  }

  // Must match expected pattern: weddings/{id}/media/... or weddings/{id}/thumbnails/...
  const validPattern = /^weddings\/[a-zA-Z0-9-]+\/(media|thumbnails)\/[a-zA-Z0-9._-]+$/;
  if (!validPattern.test(key)) {
    throw new Error('Invalid storage key: does not match expected pattern');
  }

  // Additional safeguards
  if (key.length > 500) {
    throw new Error('Invalid storage key: too long');
  }
}

export async function fetchFile(key: string): Promise<Buffer> {
  // Validate key before processing
  validateStorageKey(key);

  const config = getR2Config();
  if (!config) {
    throw new Error('R2 is not configured');
  }

  // ... rest of function unchanged
}
```

Also apply to `uploadFile()`, `deleteFile()`, and any other functions accepting keys.

## Testing

Add security test cases:

```typescript
describe('Storage Key Validation', () => {
  it('should reject path traversal attempts', async () => {
    await expect(fetchFile('weddings/../etc/passwd')).rejects.toThrow('path traversal detected');
  });

  it('should reject keys without weddings prefix', async () => {
    await expect(fetchFile('internal/secrets')).rejects.toThrow('must start with weddings/');
  });

  it('should reject invalid patterns', async () => {
    await expect(fetchFile('weddings/123/invalid/path')).rejects.toThrow('does not match expected pattern');
  });

  it('should accept valid keys', async () => {
    await expect(fetchFile('weddings/abc123/media/photo.jpg')).resolves.toBeDefined();
  });
});
```

## References

- OWASP: Server-Side Request Forgery (SSRF)
- CWE-918: Server-Side Request Forgery
- Review finding: security-sentinel

## Blockers

None

## Estimated Effort

2-3 hours (validation + tests)
